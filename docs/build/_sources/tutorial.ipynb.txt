{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h5 style=\"padding-top: 0px;padding-bottom: 0px;\">Example setup for Eyelink 1000 Plus, using PsychoPy 3.0.</h5>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Created on Wed Feb 13 15:37:43 2019\n",
    "# @author: Semeon Risom\n",
    "# @email: semeon.risom@gmail.com.\n",
    "# Sample code to run SR Research Eyelink eyetracking system. Code is optimized for the Eyelink 1000 \n",
    "# Plus (5.0), but should be compatiable with earlier systems."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <p>The sequence of operations for implementing the trial is:</p>\n",
    " <ol><li>Perform a DRIFT CORRECTION, which also serves as the pre-trial fixation target.</li>\n",
    " <li>Start recording, allowing 100 milliseconds of data to accumulate before the trial display starts.</li>\n",
    " <li>Draw the subject display, recording the time that the display appeared by placing a message in\n",
    " the EDF file.</li>\n",
    " <li>Loop until one of these events occurs RECORDING halts, due to the tracker ABORT menu or an error,\n",
    " the maximum trial duration expires 'ESCAPE' is pressed, the program is interrupted, or abutton on the\n",
    " EyeLink button box is pressed.</li>\n",
    " <li>Add special code to handle gaze-contingent display updates.</li>\n",
    " <li>Blank the display, stop recording after an additional 100 milliseconds of data has been collected.</li>\n",
    " <li>Report the trial result, and return an appropriate error code.</li></ol>\n",
    " <a>[see Pylink.chm]</a>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# import\n",
    "import os\n",
    "from psychopy import visual, monitors\n",
    "import mdl\n",
    "import time"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">Initialize the Eyelink.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Before initializing, make sure code is placedd after psychopy window instance has been created in the experiment file. \n",
    "# This window will be used in the calibration function.\n",
    "#\n",
    "# ```psychopy.visual.window.Window``` instance (for demonstration purposes only)\n",
    "subject = 1\n",
    "screensize = [1920, 1080]\n",
    "monitor = monitors.Monitor('Monitor', width=53.0, distance=65.0)\n",
    "monitor.setSizePix(screensize)\n",
    "window = visual.Window(size=screensize, fullscr=False, allowGUI=True, units='pix', monitor=monitor, \n",
    "                       winType='pyglet', color=[110,110,110], colorSpace='rgb255')\n",
    "#start\n",
    "eyetracking = mdl.eyetracking(libraries=False, window=window, subject=subject)\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">Connect to Eyelink.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# This controls the parameters to be used when running the eyetracker.\n",
    "param = eyetracking.connect(calibration_type=13)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">Set the dominamt eye.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# This step is required for recieving gaze coordinates from Eyelink->Psychopy.\n",
    "dominant_eye = 'left'\n",
    "eye_used = eyetracking.set_eye_used(eye=dominant_eye)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">Start calibration.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Before running the calibration, ensure psychopy window instance has been created in the experiment file. \n",
    "# This window will be used in the calibration function.\n",
    "eyetracking.calibration()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Enter the key \"o\" on the ```psychopy.visual.window.Window``` instance. This will begin the task. \n",
    "# The Calibration, Validation, 'task-start' events are controlled by the keyboard.\n",
    "# Calibration (\"c\"), Validation (\"v\"), task-start (\"o\") respectively."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">(Optional) Print message to console/terminal.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Allows printing color coded messages to console/terminal/cmd. This may be useful for debugging issues.\n",
    "eyetracking.console(c=\"blue\", msg=\"eyetracking.calibration() started\")"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">(Optional) Drift correction.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# This can be done at any point after calibration, including before and after \n",
    "# eyetracking.start_recording has started.\n",
    "eyetracking.drift_correction()"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">Start recording.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Note: This should be run at the start of the trial.\n",
    "# Create stimulus (demonstration purposes only). Note: There is an intentional delay of 150 msec to \n",
    "# allow the Eyelink to buffer gaze samples.\n",
    "filename = \"8380.bmp\" #filename\n",
    "path = os.getcwd() + \"/data/stimulus/\" + filename #filepath\n",
    "size = (1024, 768) #image size\n",
    "pos = (screensize[0]/2, screensize[1]/2) #positioning image at center of screen\n",
    "stimulus = visual.ImageStim(win=window, image=path, size=size, pos=(0,0), units='pix')\n",
    "\n",
    "#start\n",
    "eyetracking.start_recording(trial=1, block=1)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">(Optional) Gaze contigent event.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# This is used for realtime data collection from eyelink->psychopy.\n",
    "# For example, this can be used to require participant to look at the fixation cross for a duration\n",
    "# of 500 msec before continuing the task.\n",
    "# \n",
    "# Collect samples with the center of the screen, for 2000 msec, with a maxinum duration of 10000 msec\n",
    "# before drift correction will start.\n",
    "region = dict(left=860, top=440, right=1060, bottom=640)\n",
    "t_min = 2000\n",
    "t_max = 10000\n",
    "\n",
    "# start\n",
    "eyetracking.gc(region=region, t_min=t_min, t_max=t_max)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">(Optional) Collect current gaze coordinates from Eyelink.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# This command should be repeated at an interval of sample/2.01 msec to prevent oversampling (500Hz).\n",
    "s1 = 0 # set current time to 0\n",
    "lgxy = [] # create list of gaze coordinates (demonstration purposes only)\n",
    "s0 = time.clock() # initial timestamp\n",
    "# repeat\n",
    "while True:\n",
    "    # if difference between starting and current time is greater than > 2.01 msec, collect new sample\n",
    "    diff = (s1 - s0)\n",
    "    if diff >= .00201:\n",
    "        print(s1)\n",
    "        gxy, ps, s = eyetracking.sample(eye_used=eye_used) # get gaze coordinates, pupil size, and sample\n",
    "        lgxy.append(gxy) # store in list (not required; demonstration purposes only)\n",
    "        s0 = time.clock() # update starting time\n",
    "    #else set current time\n",
    "    else: \n",
    "        s1 = time.clock()\n",
    "\n",
    "    #break `while` statement if list of gaze coordiantes >= 20 (not required; demonstration purposes only)\n",
    "    if len(lgxy) >= 200: break"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">(Optional) Send messages to Eyelink.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# This allows post-hoc processing of event markers (i.e. \"stimulus onset\").\n",
    "# Sending message \"stimulus onset\".\n",
    "msg = \"stimulus onset\"\n",
    "eyetracking.send_message(msg=msg)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">Stop Eyelink recording.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "# Also (optional) provides trial-level variables to Eyelink.\n",
    "# Note: Variables sent are optional. If they being included, they must be in ```python dict``` format.\n",
    "#\n",
    "# set variables\n",
    "variables = dict(stimulus=filename, trial_type='encoding', race=\"black\")\n",
    "# stop recording\n",
    "eyetracking.stop_recording(trial=1, block=1, variables=variables)"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    " <h6 style=\"padding-top: 0px;padding-bottom: 0px;\">Finish Eyelink recording.</h6>"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 0,
   "metadata": {},
   "outputs": [],
   "source": [
    "eyetracking.finish_recording()"
   ]
  }
 ],
 "metadata": {
  "file_extension": ".py",
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.6.7"
  },
  "mimetype": "text/x-python",
  "name": "python",
  "npconvert_exporter": "python",
  "pygments_lexer": "ipython3",
  "version": 3
 },
 "nbformat": 4,
 "nbformat_minor": 2
}
